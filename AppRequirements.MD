TODO: Make draft message work

# Mobile Random Message Social App â€“ Requirements  (v1.0)

---

## 1Â Â Product Vision

Deliver a lightâ€‘weight, lowâ€‘friction social experience where users broadcast a single line of text to strangers and receive unexpected
thoughts in return. The app features two distinct content filtering modes:

1. Shine Mode - Strict content filtering that removes abuse, hate speech, harassment, sexism, racism and other harmful content to maintain a
   positive environment
2. Shadow Mode - Light content filtering that only removes illegal content (drug trafficking, exploitation of minors, explicit violence)
   while allowing more controversial expression

The app balances these contrasting approaches while rewarding creativity and respectful engagement.

## 2  Business Goals

1. **Daily Delight:**â€¯Drive habitual, microâ€‘time engagement (30â€‘60Â s sessions).
2. **Viral Growth Loop:**â€¯Pushâ€‘notification delivery of messages â†’ ratings â†’ wider distribution â†’ screenshots/shared quotes.
3. **Positive Netâ€‘Promoter Score:**â€¯Minimise harassment via optâ€‘in â€œShineâ€ mode and rateâ€‘gated exposure in â€œShadowâ€ mode.
4. **MonetisationÂ (PhaseÂ 2):**Â Sponsored prompts, coin packs for additional replies, themed UI skins.

## 3Â Â Personas & Useâ€‘Cases

| Persona                | Motivation                                  | Key Flows                                               |
|------------------------|---------------------------------------------|---------------------------------------------------------|
| **The Supportâ€‘Seeker** | Wants to brighten someoneâ€™s day & feel good | Writes in *Shine*, rates messages, builds streaks       |
| **The Ranter**         | Needs a safe outlet for spicy takes         | Writes in *Shadow*, hunts witty lines                   |
| **The Lurker**         | Prefers reading & rating                    | Receives notifications, rarely writes                   |
| **The Connector**      | Enjoys making new friends and networking    | Engages actively, replies to messages, shares content   |
| **The Critic**         | Provides thoughtful feedback and ratings    | Rates messages carefully, reports inappropriate content |
| **The Creator**        | Loves crafting unique and creative lines    | Writes frequently, experiments with styles and tones    |

## 4Â Â MVP Feature Set

### 4.1Â Onboarding & Tutorial Sequence

* **Multiâ€‘Page Intro:** A threeâ€‘panel carousel explaining core mechanics:

  1. **Random Broadcast:** â€œWrite a short line. We'll deliver it randomly to active users.â€ Diagram of dots moving between devices.
  2. **Mode Toggle:** â€œDrag or tap the sun icon to switch modes.â€ Demo animation where the sun sinks and the moon emerges.
  3. **Receive & Rate:** â€œWhen messages arrive, read and rate them.â€ Includes swipe gesture visual.
* **Autoâ€‘Advance & Skip:** Panels autoâ€‘advance after 2â€“3Â seconds; â€œSkipâ€ becomes available after the first panel.
* \*\*Set Nickname Prompt: Immediately after intro, show auth page.

  * Footer contains a **Privacy Policy** link.
  * Pushâ€‘notification permission request fires once nickname is confirmed.

### 4.1.1 New Authentication Flow (Updated Implementation)

**State 1 - Initial/Unauthenticated:**

* Display welcome message explaining the app concept: "Share random thoughts with strangers and discover unexpected perspectives"
* Show "Log in with Google" button as the primary action
* Hide all other UI elements until Google authentication is complete

**State 2 - Post-Google Authentication:**

* If user already exists in backend: Navigate directly to main screen
* If user is new (not registered in backend):
  * Show nickname input field with real-time validation
  * Show "Create Account" button (enabled only when nickname is valid)
  * Validate nickname availability via `/api/user/check-name-availability`
  * Send `createUser` API request when submitted
  * Navigate to main screen after successful user creation

**Technical Implementation:**

* Single Google Sign-In flow for both new and existing users
* Backend user existence determined via `/api/user/current` endpoint after Google authentication
* Follows API contract specified in section 9 for user creation and validation
* Push notification permission request fires after successful authentication

### 4.2 UI Navigation Tabs

Establish four primary tabs in the bottom navigation bar to support the Writeâ€‘focused flow and clear separation of content:

| Position | Purpose                                        | Label    | Icon |
|----------|------------------------------------------------|----------|------|
| **1.**   | Compose and view your last 3 sent messages     | Write    | âœï¸   |
| **2.**   | Sent messages + their replies (tap for thread) | My Posts | ğŸ’¬   |
| **3.**   | Review messages youâ€™ve received and reply      | Inbox    | ğŸ“¥   |
| **4.**   | Account settings and profile                   | Account  | ğŸ‘¤   |

### 4.3Â  Account & Settings

* Google signâ€‘in links messages across devices.
* Avatar & 80â€‘char bio.
* Language + Locale selector (default phone locale).

### 4.4 Error & Informational States

* **Offline send failure:** Silently display a small progress icon on the message and do the Background retry via WorkManager.
* **Nickname already taken:** Inline field error prompting a new name.
* **Moderation rejection (Shine):** Dialog suggests switching to Shadow mode if the user wants uncensored wording.
* **Push permission denied:** Snackbar outlining that pushes are essential to the experience and promising no spam, plus a button to open system settings.
* **No messages yet:** Emptyâ€‘state copy: â€œNo messages yet.â€

**Spam/Flood Control:** Backend enforces a **30â€‘second** minimum interval between sends; returns HTTPÂ 429 with a friendly error.


## 5Â Â Future (Postâ€‘MVP) Backlog

1. **Iterative Distribution:**Â â‰¥â€¯4â˜… average after firstÂ 10 ratings â‡’ resend toâ€¯Ã—10 users.
2. **Adaptive Notifications:**Â Behaviourâ€‘based quota (1â€‘4 per day).
3. **Locale Hints:**Â Keyboard language â‰  selected locale â‡’ prompt switch.
4. **Public Inbox Experiment:**Â Top 50 daily messages in readâ€‘only inbox.
5. **Moderation Dashboard:** Admin web panel, realâ€‘time abuse reports.
6. **Report / Block Abuse:** Inâ€‘app â€œReportâ€ action on any message (PhaseÂ 2)

## 6Â Â Nonâ€‘Functional Requirements

* **Latency:**Â <300Â ms API roundâ€‘trip for message send.
* **Scalability:**Â Use topicâ€‘based FCM for batched sends.
* **Legal:**Â Comply with GDPR/CCPA.
* **Analytics:** Instrument Firebase Analytics to track key events (app*open, send\_message, receive\_notification, open\_notification,
  dismiss\_*notification, rate\_message, toggle\_mode) and funnel metrics for ongoing product improvement.
* **Crash Reporting:** Integrate Firebase Crashlytics for realâ€‘time crash and ANR monitoring.
* **Spam/Flood Control:** 30â€‘second minimum send interval enforced serverâ€‘side.
* **Kotlin Multiplatform Preparedness:** Structure the Android codebase (business logic, network layer) to facilitate a future migration to Kotlin Multiplatform (KMP) for shared modules across mobile platforms.
  Avoid Java libs - use Kotlin-based libs if possible.

### 6.1Â Content Filtering for Shine Mode

To automatically moderate user-generated text in **Shine** mode with a lightweight integration, adopt a hybrid of server-side ML and client-side filtering:

| Tool / Service                       | Platform         | Key Features                                                              | Integration Effort                                                            |
| ------------------------------------ | ---------------- | ------------------------------------------------------------------------- | ----------------------------------------------------------------------------- |
| **OpenAI Moderation API**            | Backend          | Multidimensional policy checks: abuse, hate, sexual, self-harm, profanity | Single REST call to `/moderations`; free and unlimited usage (no token quota) |
| **Firebase ML Kit Profanity Filter** | Mobile (Android) | On-device simple profanity blacklist; instant feedback                    | Add ML Kit SDK + Profanity Extension                                          |

**Recommended MVP Approach:**

1. **Server-Side Enforcement:** For every Shineâ€‘mode submission, call the **OpenAI Moderation API**. If any category (e.g., profanity, hate)
   exceeds the threshold (e.g., 0.6), reject with a user-friendly error: â€œPlease keep it positive or switch to Shadow mode!â€
2. **Client-Side Quick Check:** Use **Firebase ML Kit Profanity Filter** in the Android app to flag disallowed words instantly, helping users self-correct before sending.
3. **Custom Blocklist (Optional):** Maintain a small server-hosted JSON list of brandâ€‘ or cultureâ€‘specific banned terms; screen messages against it postâ€‘API check.

This hybrid solution gives robust, free moderation out of the box, minimizes false positives through client prompts, and keeps your server code simple.

## 7Â Â Technical Architecture (Highâ€‘Level)


flowchart TD
  Mobile(Android) -- REST/JSON --> API(Gateway)
  API --> Node(NestJS Service Cluster)
  Node -- ORM --> DB(PostgreSQL)
  Node --> FCM(Push)
  Cron(Scheduled Jobs) --> Node


* **Security:**Â Bearer `token` header for user JWT; `x-api-key` for cron jobs.
* **Data Storage:** Users, Messages, Replies (see Â§8).
* **Push Delivery:** Outgoing messages are delivered via Firebase Cloud Messaging (FCM) to **randomly selected** active users within the same mode.

## 8Â Â Data Model Summary

| Entity          | Key Fields                                                                    | Relations                 |
|-----------------|-------------------------------------------------------------------------------|---------------------------|
| **User**        | id String, name, registrationToken?, coins, createdAt, updatedAt              | 1â€‘\* Message, 1â€‘\* Reply  |
| **Message**     | id, body, mode, isPublic, authorId, createdAt, localState, tempId?, needsSync | *â€‘1 User, 1â€‘* Reply       |
| **Reply**       | id, body, mode, isPublic, parentId?, authorId, createdAt, updatedAt           | \*â€‘1 Message, selfâ€‘nested |
| **UnsentDraft** | body, mode, timestamp *(Client-only)*                                         | N/A                       |

## 9Â Â API Contract Coverage (Postman)

Below are the canonical endpoints as documented in Postman. Note that server currently uses `mode` values `light` or `dark` (to be renamed to `shine`/`shadow` via migration).

### User Endpoints

* **Create user**
  `POST /api/user`
  â€¢ **Request Body** (JSON):
  â€¢ `name` (string, required): Userâ€™s nickname.
  â€¢ `registrationToken` (string, optional): FCM registration token for push notifications.
  â€¢ **Response** (201 Created, JSON):
  â€¢ `id` (string)
  â€¢ `name` (string)
  â€¢ `updatedAt` (string)
  â€¢ `createdAt` (string)

* **Get current user**
  `GET /api/user/current`
  â€¢ **Headers**: `token: <user-token>`
  â€¢ **Response** (200 OK, JSON):
  â€¢ `id` (string)
  â€¢ `name` (string)
  â€¢ `createdAt` (string)
  â€¢ `updatedAt` (string)

* **Update current user**
  `PATCH /api/user/current`
  â€¢ **Headers**: `token: <user-token>`
  â€¢ **Request Body** (JSON, optional fields):
  â€¢ `name` (string)
  â€¢ `registrationToken` (string)
  â€¢ **Response** (200 OK, JSON): Updated user object (same fields as Get current user).

* **Check name availability**
  `GET /api/user/check-name-availability?name=<string>`
  â€¢ **Response** (200 OK, JSON):
  â€¢ `nameIsAvailable` (boolean)

### Message Endpoints

* **Create message**
  `POST /api/message`
  â€¢ **Headers**: `token: <user-token>`
  â€¢ **Request Body** (JSON):
  â€¢ `body` (string, required)
  â€¢ `mode` (string, required): `"light"` or `"dark"`
  â€¢ **Response** (201 Created, JSON):
  â€¢ `id` (string)
  â€¢ `public` (boolean, always true)
  â€¢ `wasSent` (boolean, false if queued)
  â€¢ `body` (string)
  â€¢ `mode` (string)
  â€¢ `authorId` (string)
  â€¢ `updatedAt` (string)
  â€¢ `createdAt` (string)
  â€¢ `parentId` (null)

* **Rate message**
  `PATCH /api/message/{id}/rate`
  â€¢ **Headers**: `token: <user-token>`
  â€¢ **Request Body** (JSON):
  â€¢ `rating` (string): `"dislike"`, `"like"`, or `"superlike"`
  â€¢ **Response** (200 OK, no body)

* **Get incoming messages**
  `GET /api/message/current/incoming`
  â€¢ **Headers**: `token: <user-token>`
  â€¢ **Response** (200 OK, JSON Array of messages): Fields per message:
  â€¢ `id`,Â `body`,Â `mode`,Â `public`,Â `wasSent`,Â `createdAt`,Â `updatedAt`,Â `authorId`,Â `parentId` (string or null)
  â€¢ `replies` (array of reply objects, may be omitted if empty)

* **Get outcoming messages**
  `GET /api/message/current/outcoming`
  â€¢ **Headers**: `token: <user-token>`
  â€¢ **Response** (200 OK, JSON Array of messages): Same schema as incoming, but ordered by userâ€™s own authored messages.

### Reply Endpoints

> Note: In MVP, coin-based reply creation is disabled. Replies still use `public` flag for privacy.

* **Create reply**
  `POST /api/reply`
  â€¢ **Headers**: `token: <user-token>`
  â€¢ **Request Body** (JSON):
  â€¢ `body` (string, required)
  â€¢ `public` (boolean, required)
  â€¢ `parentId` (string, required): ID of parent message or reply
  â€¢ **Response** (201 Created, JSON):
  â€¢ `id`,Â `wasSent` (boolean),Â `body`,Â `public`,Â `mode`,Â `parentId`,Â `authorId`,Â `updatedAt`,Â `createdAt`

* **Update reply**
  `PATCH /api/reply`
  â€¢ **Headers**: `token: <user-token>`
  â€¢ **Request Body** (JSON):
  â€¢ `id` (string, required)
  â€¢ `public` (boolean, optional)
  â€¢ **Response** (200 OK, JSON): Updated reply object with full fields.

* **Get reply by ID**
  `GET /api/reply/{id}`
  â€¢ **Headers**: `token: <user-token>`
  â€¢ **Response** (200 OK, JSON): Reply object, including nested `replies` array.

### Cron Job

* **Send messages job**
  `POST /api/cron/send-messages`
  â€¢ **Headers**: `x-api-key: <cron-key>`
  â€¢ **Response**: 200 OK on success.

## 10Â Â Naming â€“ Modes

| Positive Mode | Unfiltered Mode |
| ------------- | --------------- |
| **Shine**     | **Shadow**      |

*(Locked for MVP)*

## 11Â Â Resolved Decisions

1. **Maximum daily sends per user:** Limited to 10 messages per day in PhaseÂ 1.
2. **Shadow mode content filtering:** Explicit illegal content will still be filtered starting with PhaseÂ 2.
3. **Economy mechanics (coin sink/inflation control):** Deferred to PhaseÂ 2 backlog.
4. **Translation vs. locale restriction:** ML-driven autoâ€‘detect deferred to PhaseÂ 2.
5. **Tablet / foldable layouts:** Not a priority for MVP.

---
